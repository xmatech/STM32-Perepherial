/**
-------------------------------------------------------------------------------------------------------------------------------------------------------
 * @file        : tim.c
 * @brief       : Инициализация таймера TIM1 для работы в режиме PWM (ШИМ) на канале 4 (PE14).
 * @author      : xmatech
 * @date        : 14.01.2025
 * @board       : JZ-F407VET6
 * @MCU         : STM32F407VET6
 * @IDE         : Segger Embedded Studio
 *
 * @Description : Настройка таймера TIM1 для генерации ШИМ-сигнала на пине PE14 (TIM1_CH4). 
 *                Включает тактирование TIM1 и GPIOE, настраивает пин PE14 как альтернативную функцию,
 *                устанавливает предделитель, период и коэффициент заполнения для ШИМ.
----------------------------------------------------------------------------------------------------------------------------------------------------------
 */

#include "main.h"

/**
 * @brief Инициализация таймера TIM1.
 * @details Настройка таймера TIM1 для работы в режиме PWM (ШИМ) на канале 4 (PE14).
 */
void tim1_init(void) {
    // Включение тактирования TIM1 и GPIOE
    RCC->APB2ENR |= RCC_APB2ENR_TIM1EN;  // Включение TIM1
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOEEN; // Включение GPIOE

    // Настройка пина PE14 как альтернативной функции (TIM1_CH4)
    GPIOE->MODER |= GPIO_MODER_MODE14_1;                                  // Альтернативный режим (10)
    GPIOE->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR14_1;                          // Высокая скорость
    GPIOE->AFR[1] &= ~(0xF << (4 * 6));                                   // Очистка битов для PE14
    GPIOE->AFR[1] |= (0x1 << (4 * 6));                                    // Установка AF1 (TIM1_CH4)
                                                                          
    // Настройка таймера TIM1                                             
    TIM1->PSC = 84 - 1;                                                   // Предделитель: 84 МГц / 84 = 1 МГц
    TIM1->ARR = 1000 - 1;                                                 // Автоперезагрузка: период 1 мс (1 МГц / 1000)
    TIM1->CCR4 = 1;                                                       // Начальное значение коэффициента заполнения

    // Настройка режима PWM Mode 2 для канала 4
    TIM1->CR1 |= TIM_CR1_CMS;  // Режим выравнивания по центру
    TIM1->CCMR2 |= TIM_CCMR2_OC4M_2 | TIM_CCMR2_OC4M_1 | TIM_CCMR2_OC4M_0; // PWM Mode 2
    TIM1->CCMR2 &= ~TIM_CCMR2_CC4S;                                        // Режим выхода для канала 4
    TIM1->CCER |= TIM_CCER_CC4E;                                           // Включение канала 4
    TIM1->BDTR |= TIM_BDTR_MOE;                                            // Включение выхода
    TIM1->CR1 |= TIM_CR1_CEN;                                              // Запуск таймера
    TIM1->EGR |= TIM_EGR_UG;                                               // Обновление регистров
}